# SPDX-FileCopyrightText: 2026 KDE Contributors
# SPDX-License-Identifier: CC0-1.0

include:
  - project: sysadmin/ci-utilities
    file:
      - /gitlab-templates/reuse-lint.yml
      - /gitlab-templates/linux-qt6.yml

# Test if LXD/Incus can run in the KDE CI VM
# Uses snap-builder image which has LXD pre-configured
container_test:
  stage: build
  image: storage.kde.org/vm-images/snap-builder
  tags:
    - amd64
    - VM
  script:
    # Check what we're running on
    - echo "=== System Info ==="
    - uname -a
    - cat /etc/os-release
    - id
    - groups
    
    # Check LXD status (should be pre-configured on snap-builder)
    - echo "=== LXD Status ==="
    - which lxd lxc || echo "LXD not found"
    - lxc version || echo "lxc version failed"
    
    # Try listing (to verify daemon is working)
    - echo "=== Testing LXD ==="
    - lxc list || echo "lxc list failed"
    
    # Try creating a simple container
    - echo "=== Creating Test Container ==="
    - lxc launch images:alpine/edge test-ci || echo "Container creation failed"
    - lxc list || true
    
    # Run a command in the container
    - echo "=== Running Command in Container ==="
    - lxc exec test-ci -- cat /etc/os-release || echo "exec failed"
    
    # Cleanup
    - lxc delete test-ci --force 2>/dev/null || true
    
  rules:
    - when: always  # Run on all pipelines for now
  allow_failure: true  # Don't block other jobs while we experiment
