# SPDX-FileCopyrightText: 2026 KDE Contributors
# SPDX-License-Identifier: CC0-1.0

include:
  - project: sysadmin/ci-utilities
    file:
      - /gitlab-templates/reuse-lint.yml
      - /gitlab-templates/linux-qt6.yml

# Integration tests using Incus on snap-builder VM
# Tests container creation/deletion via Kapsule's D-Bus interface
integration_test:
  stage: build
  image: storage.kde.org/vm-images/snap-builder
  tags:
    - amd64
    - VM
  script:
    # System info
    - echo "=== System Info ==="
    - uname -a
    - cat /etc/os-release
    - id && groups
    
    # Verify LXD works (pre-installed)
    - echo "=== LXD Status ==="
    - lxc version
    
    # Install Incus via Zabbly repo (official Incus packages for Ubuntu)
    - echo "=== Installing Incus ==="
    - |
      sudo mkdir -p /etc/apt/keyrings
      sudo curl -fsSL https://pkgs.zabbly.com/key.asc -o /etc/apt/keyrings/zabbly.asc
      echo "deb [signed-by=/etc/apt/keyrings/zabbly.asc] https://pkgs.zabbly.com/incus/stable $(. /etc/os-release && echo ${VERSION_CODENAME}) main" | sudo tee /etc/apt/sources.list.d/zabbly-incus-stable.list
      sudo apt-get update -qq
      sudo apt-get install -y -qq incus
    
    # Initialize Incus
    - echo "=== Setting up Incus ==="
    - sudo systemctl start incus || sudo incusd &
    - sleep 2
    - sudo incus admin init --minimal
    
    # Verify Incus works
    - echo "=== Testing Incus ==="
    - sudo incus list
    
    # Install Python test dependencies
    - echo "=== Installing Python Dependencies ==="
    - pip install --quiet pytest pytest-asyncio dbus-fast httpx pydantic rich typer pyyaml
    
    # Start Kapsule daemon on system bus (requires root)
    - echo "=== Starting Kapsule Daemon ==="
    - export PYTHONPATH="${CI_PROJECT_DIR}/src"
    - sudo -E python -m daemon --system &
    - sleep 3
    
    # Run integration tests (need root to access system bus as owner)
    - echo "=== Running Integration Tests ==="
    - sudo -E PYTHONPATH="${CI_PROJECT_DIR}/src" pytest tests/integration/ -v --tb=short || true
    
  rules:
    - when: always
  allow_failure: true  # Don't block while experimenting
